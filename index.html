<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PenguinFlix - Twój Dziennik Filmowy</title>

    <meta name="theme-color" content="#101114" id="theme-color-meta"/>
    <meta name="color-scheme" content="dark" id="color-scheme-meta">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --bg-color: #101114;
            --card-color: #202227;
            --text-color: #E1E1E1;
            --text-secondary: #8e9297;
            --border-color: #303339;
            --primary-color: #E50914;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --header-height: 130px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --transition-speed: 0.25s;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        [data-theme="light"] {
            --bg-color: #f0f2f5;
            --card-color: #ffffff;
            --text-color: #1c1e21;
            --text-secondary: #65676b;
            --border-color: #ced0d4;
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html {
            scroll-behavior: smooth;
            color-scheme: light dark;
        }

        html, body {
            background-color: var(--bg-color);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-color);
            margin: 0;
            padding-top: calc(var(--header-height) + var(--safe-top));
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        #fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 12px 16px;
            padding-top: calc(12px + var(--safe-top));
            background: color-mix(in srgb, var(--bg-color) 85%, transparent);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-speed), border-color var(--transition-speed);
        }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
        .app-logo-icon { width: 36px; height: 36px; fill: var(--primary-color); flex-shrink: 0; }
        .header-actions { display: flex; align-items: center; gap: 4px; }
        .search-wrapper { position: relative; flex-grow: 1; }
        #searchInput { width: 100%; padding: 12px 16px 12px 44px; border-radius: var(--radius-md); border: 1px solid var(--border-color); background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-color)); color: var(--text-color); font-size: 1rem; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; fill: var(--text-secondary); pointer-events: none; }

        .list-tabs { display: flex; justify-content: space-around; gap: 8px; }
        .tab-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-button svg { width: 24px; height: 24px; fill: var(--text-secondary); transition: fill 0.2s; }
        .tab-button:hover { color: var(--text-color); }
        .tab-button:hover svg { fill: var(--text-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-button.active svg { fill: var(--primary-color); }

        #searchResults {
            display: none;
            position: fixed;
            top: calc(var(--header-height) + var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            z-index: 1200;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }
        .search-item { display: flex; align-items: center; padding: 12px 16px; gap: 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color var(--transition-speed); }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-color)); }
        .search-item img { width: 40px; height: 60px; object-fit: cover; border-radius: var(--radius-sm); }
        .search-item .info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }
        .search-item .info strong { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .search-item .info span { color: var(--text-secondary); font-size: 0.9em; }
        .search-item .actions { display: flex; gap: 8px; margin-left: auto; flex-shrink: 0; }

        #app {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px;
            min-height: calc(100dvh - (var(--header-height) + var(--safe-top)));
            display: flex;
            flex-direction: column;
        }

        .view-controls { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 16px; }
        .view-controls .button { background-color: var(--card-color); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 16px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: color 0.2s, border-color 0.2s; }
        .view-controls .button.active { color: var(--primary-color); border-color: var(--primary-color); }
        .view-controls .button.active svg { fill: var(--primary-color); }
        .view-controls .button svg { width: 20px; height: 20px; fill: var(--text-secondary); transition: fill 0.2s; }

        .icon-button { background: transparent; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; transition: background-color var(--transition-speed); }
        .icon-button:hover { background-color: var(--border-color); }
        .icon-button svg { width: 22px; height: 22px; fill: var(--text-secondary); transition: fill 0.2s; }

        .favorite-btn.active svg { fill: var(--warning-color); }

        .list-container { display: none; }
        .list-container.active { display: block; animation: fadeIn 0.3s; }
        ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .list-item { display: flex; padding: 12px; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: var(--radius-md); gap: 16px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .list-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .list-item img { width: 60px; height: 90px; object-fit: cover; border-radius: var(--radius-sm); flex-shrink: 0; }
        .list-item .info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; }
        .list-item .info strong { font-size: 1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .info .meta { font-size: 0.85rem; color: var(--text-secondary); }
        .list-item .info .overview { font-size: 0.9rem; color: var(--text-secondary); margin-top: 8px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .star-rating-display { display: flex; gap: 2px; margin-top: auto; padding-top: 6px; }
        .star-rating-display svg { width: 18px; height: 18px; }
        .list-item .item-actions { margin-left: auto; align-self: center; display: flex; }

        .progress-container { margin-top: auto; padding-top: 8px; }
        .progress-text { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
        .progress-bar { width: 100%; height: 6px; background-color: var(--border-color); border-radius: 3px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background-color: var(--primary-color); border-radius: 3px; transition: width 0.3s ease-out; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content {
            position: relative;
            background: var(--card-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 100%;
            max-width: 580px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
        }

        .modal-top-close-btn { position: absolute; top: 12px; right: 12px; z-index: 10; }
        .modal-top-close-btn svg { fill: var(--text-secondary); }

        .modal-header { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-direction: column; }
        .modal-header img { width: 130px; height: 195px; object-fit: cover; border-radius: var(--radius-md); flex-shrink: 0; margin: 0 auto; }
        .modal-title-wrapper { display: flex; align-items: center; gap: 8px; }
        .modal-title { text-align: center; flex-grow: 1; }
        .modal-title h2 { margin: 0 0 12px; }
        .genres { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .genre-tag { background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-color)); color: var(--text-secondary); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; }
        @media (min-width: 600px) {
            .modal-header { flex-direction: row; align-items: flex-start; }
            .modal-header img { margin: 0; }
            .modal-title { text-align: left; }
            .genres { justify-content: flex-start; }
        }

        #customAlert .modal-content, #customAddModal .modal-content { max-width: 90vw; width: 400px; text-align: center; }
        #customAlert p, #customAddModal p { margin: 0 0 16px; color: var(--text-secondary); }

        .star-rating-interactive { display: flex; gap: 5px; justify-content: center; }
        .star-rating-interactive .star { position: relative; width: 32px; height: 32px; cursor: pointer; }
        .star-rating-interactive .star svg { width: 100%; height: 100%; position: absolute; top:0; left:0; }
        .star-rating-interactive .star-background { fill: var(--border-color); }
        .star-rating-interactive .star-foreground { fill: var(--warning-color); transition: clip-path 0.1s ease; }

        .rating-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin: 12px 0 16px;
        }
        .rating-controls button {
            background-color: var(--border-color);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            line-height: 1;
        }
        .rating-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .rating-display {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 150px;
            text-align: center;
        }

        .control-modal-content { max-width: 420px; background: var(--card-color); border-radius: var(--radius-lg); padding: 24px; animation: scaleIn 0.3s ease-out; }
        .control-modal-content h3 { margin: 0 0 16px; font-size: 1.1rem; text-align: center; }
        .control-modal-options { display: flex; flex-direction: column; gap: 8px; max-height: 40vh; overflow-y: auto; padding-right: 8px; }
        .control-modal-options label { display: block; padding: 12px; border-radius: var(--radius-md); cursor: pointer; transition: background-color var(--transition-speed); }
        .control-modal-options label:hover { background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-color)); }
        .control-modal-options input { margin-right: 12px; accent-color: var(--primary-color); }
        .control-modal-footer { margin-top: 24px; display: flex; justify-content: space-between; gap: 12px; }
        .control-modal-footer button { padding: 12px 20px; border: none; border-radius: var(--radius-md); font-weight: bold; cursor: pointer; flex-grow: 1; }
        .control-modal-footer .reset-btn { background-color: var(--border-color); color: var(--text-color); }
        .control-modal-footer .apply-btn { background-color: var(--primary-color); color: white; }

        /* Styles for Custom Add Modal Form */
        #custom-add-form { display: flex; flex-direction: column; gap: 16px; text-align: left; }
        #custom-add-form input[type="text"], #custom-add-form input[type="number"] { width: 100%; padding: 12px; background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; }
        #custom-add-form .radio-group { display: flex; gap: 16px; justify-content: center; }
        #custom-add-form .radio-group label { display: flex; align-items: center; gap: 8px; }
        #custom-add-form .form-actions { display: flex; gap: 12px; justify-content: flex-end; }
        #custom-add-form button { padding: 12px 20px; border-radius: var(--radius-md); font-weight: bold; cursor: pointer; border: none; }
        #custom-add-form .cancel-btn { background-color: var(--border-color); color: var(--text-color); }
        #custom-add-form .save-btn { background-color: var(--primary-color); color: white; }


        #info-fab {
            position: fixed;
            bottom: calc(40px + var(--safe-bottom));
            right: 20px;
            z-index: 1050;
            width: 56px;
            height: 56px;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease-out, background-color 0.2s;
        }
        #info-fab:hover {
            transform: scale(1.05);
            background-color: color-mix(in srgb, var(--card-color) 80%, var(--bg-color));
        }
        #info-fab svg {
            width: 28px;
            height: 28px;
            fill: var(--text-color);
        }

        #infoModal .modal-content { text-align: center; line-height: 1.6; }
        #infoModal h2 { display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 1.5rem; color: var(--primary-color); }
        #infoModal h3 { border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 24px; }
        #infoModal .important-note { background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); border-left: 4px solid var(--primary-color); padding: 12px; border-radius: var(--radius-sm); text-align: left; margin: 16px 0; }
        #infoModal .tmdb-logo { width: 100px; margin-top: 16px; }

        #force-light-mode-hack {
            filter: invert(0.000000000001%);
        }

        .cast-section, .known-for-section, .seasons-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .cast-section h3, .known-for-section h3, .seasons-section h3 {
            margin-bottom: 16px;
        }
        .cast-scroller, .known-for-scroller {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        .cast-scroller::-webkit-scrollbar, .known-for-scroller::-webkit-scrollbar { height: 6px; }
        .cast-scroller::-webkit-scrollbar-track, .known-for-scroller::-webkit-scrollbar-track { background: transparent; }
        .cast-scroller::-webkit-scrollbar-thumb, .known-for-scroller::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; }
        .cast-member {
            flex-shrink: 0;
            width: 90px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .cast-member:hover { transform: scale(1.05); opacity: 0.9; }
        .cast-member img, .cast-member .placeholder-svg {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--border-color);
            border: 2px solid var(--card-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin: 0 auto;
        }
         .cast-member .placeholder-svg { padding: 16px; fill: var(--text-secondary); }
        .cast-member strong { display: block; margin-top: 8px; font-size: 0.9em; line-height: 1.3; font-weight: 600; }
        .cast-member span { font-size: 0.8em; color: var(--text-secondary); line-height: 1.2; }

        .actor-modal-overlay { z-index: 3000; }
        .actor-modal-content { max-width: 620px; padding: 24px; }
        .actor-header { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 24px; }
        .actor-header img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); }
        .actor-header h2 { margin: 0; font-size: 1.8rem; text-align: center; }
        .actor-bio { line-height: 1.6; color: var(--text-secondary); max-height: 150px; overflow-y: auto; padding-right: 10px; }
        .known-for-item { flex-shrink: 0; width: 100px; }
        .known-for-item img { width: 100px; height: 150px; object-fit: cover; border-radius: var(--radius-sm); }
        .known-for-item strong { display: block; font-size: 0.85em; margin-top: 6px; white-space: normal; }
         @media (min-width: 600px) {
            .actor-header { flex-direction: row; text-align: left; }
             .actor-header h2 { text-align: left; }
        }

        .filmography-controls { margin-top: 24px; text-align: center; }
        .filmography-button { background-color: var(--border-color); color: var(--text-color); border: none; padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed); }
        .filmography-button:hover { background-color: color-mix(in srgb, var(--border-color) 80%, var(--bg-color)); }
        #full-filmography-container { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .filmography-item { border-bottom: 1px solid var(--border-color); }
        .filmography-item:last-child { border-bottom: none; }
        .filmography-item-header { display: flex; align-items: center; gap: 16px; padding: 12px 4px; cursor: pointer; }
        .filmography-item-header:hover { background-color: color-mix(in srgb, var(--card-color) 50%, var(--border-color)); }
        .filmography-item img { width: 50px; height: 75px; object-fit: cover; border-radius: var(--radius-sm); flex-shrink: 0; background-color: var(--border-color); }
        .filmography-item-info { display: flex; flex-direction: column; gap: 4px; }
        .filmography-item-info strong { font-size: 1em; }
        .filmography-item-info span { font-size: 0.9em; color: var(--text-secondary); }
        .filmography-item-info .character { font-style: italic; }
        .filmography-item-details { display: none; padding: 0 12px 16px; animation: fadeIn 0.4s; }
        .filmography-overview { font-size: 0.9em; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; }
        .filmography-actions { text-align: right; }
        .add-filmography-item-btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; font-size: 0.85em; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; }
        .add-filmography-item-btn:disabled { background-color: var(--border-color); cursor: not-allowed; }
        .already-added-info { font-size: 0.9em; font-weight: 600; color: var(--success-color); display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
        .already-added-info svg { width: 18px; height: 18px; fill: var(--success-color); }

        .season-details { border-bottom: 1px solid var(--border-color); }
        .season-details:last-child { border-bottom: none; }
        .season-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        .season-summary:hover { background-color: color-mix(in srgb, var(--card-color) 50%, var(--border-color)); }
        .season-summary h4 { margin: 0; font-size: 1.1rem; }
        .season-progress { font-size: 0.9rem; color: var(--text-secondary); }
        .episodes-list { padding: 0 8px 16px; display: none; }
        .episode-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 12px 4px;
            border-bottom: 1px solid var(--border-color);
        }
        .episode-item:last-child { border-bottom: none; }
        .episode-info { display: flex; flex-direction: column; align-items: flex-start; gap: 8px; flex-grow: 1; }
        .episode-title-line { display: flex; align-items: baseline; gap: 12px; }
        .episode-number { color: var(--text-secondary); font-weight: 600; }
        .episode-title { font-weight: 500; }
        .episode-overview { font-size: 0.85em; color: var(--text-secondary); line-height: 1.5; padding-left: 28px; }

        .episode-status-toggle {
            position: relative;
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            flex-shrink: 0;
        }
        .episode-status-toggle:hover { background-color: var(--border-color); }
        .episode-status-toggle:active { transform: scale(0.9); }
        .episode-status-toggle input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .episode-status-toggle .icon {
            width: 24px;
            height: 24px;
            transition: fill 0.2s;
        }
        .icon-unwatched { display: block; fill: var(--text-secondary); }
        .icon-watched { display: none; fill: var(--success-color); }
        .episode-status-toggle input:checked ~ .icon-unwatched { display: none; }
        .episode-status-toggle input:checked ~ .icon-watched { display: block; }
        .season-actions { padding: 0 12px 12px; }
        .season-toggle-all-btn {
            background: none; border: 1px solid var(--border-color); color: var(--text-secondary);
            font-size: 0.8rem; font-weight: 600; padding: 6px 12px; border-radius: var(--radius-md);
            cursor: pointer; transition: color 0.2s, border-color 0.2s;
        }
        .season-toggle-all-btn:hover { color: var(--text-color); border-color: var(--text-color); }
        .loading-episodes { text-align: center; padding: 20px; color: var(--text-secondary); }

        @media (max-width: 600px) {
            #fixed-header { padding-left: 12px; padding-right: 12px; }
            .top-bar { gap: 8px; }
            .tab-button span { font-size: 0.65rem; }
            #app { padding: 16px; }
            #searchResults { width: calc(100vw - 24px); }
        }
    </style>
</head>
<body>
    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="display: none;" id="force-light-mode-hack">
    <header id="fixed-header">
        <div class="header-content">
            <div class="top-bar">
                <svg class="app-logo-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M401.7,144.2C382.4,106.6,343.3,80,299.7,80c-48.5,0-88.7,35.5-96.8,81.4c-42.5,0-76.8,34.4-76.8,76.8 c0,35.1,22.4,64.8,53.2,73.8c-7.3,4.4-15.6,6.9-24.4,6.9c-32.1,0-58.1,26-58.1,58.1h29.1c0-16,13-29.1,29.1-29.1 s29.1,13,29.1,29.1h29.1h29.1h29.1c0-16,13-29.1,29.1-29.1s29.1,13,29.1,29.1h29.1c0-32.1-26-58.1-58.1-58.1 c-8.8,0-17.1,2.5-24.4-6.9c30.8-9,53.2-38.7,53.2-73.8C478.5,178.6,444.2,144.2,401.7,144.2z M241.6,220.3 c-12,0-21.8-9.8-21.8-21.8s9.8-21.8,21.8-21.8s21.8,9.8,21.8,21.8S253.6,220.3,241.6,220.3z M358.4,220.3 c-12,0-21.8-9.8-21.8-21.8s9.8-21.8,21.8-21.8s21.8,9.8,21.8,21.8S370.4,220.3,358.4,220.3z"/></svg>
                <div class="search-wrapper">
                    <input type="search" id="searchInput" placeholder="Szukaj..." autocomplete="off"/>
                    <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                </div>
                <div class="header-actions">
                    <button id="custom-add-btn" class="icon-button" title="Dodaj ręcznie"><svg viewBox="0 0 24 24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg></button>
                    <button id="theme-toggle" class="icon-button" title="Zmień motyw"></button>
                    <label for="restoreInput" class="icon-button" title="Importuj"><svg viewBox="0 0 24 24"><path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" /></svg></label>
                    <input type="file" id="restoreInput" accept=".json" style="display:none">
                    <button id="backupButton" class="icon-button" title="Eksportuj"><svg viewBox="0 0 24 24"><path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" /></svg></button>
                </div>
            </div>
            <div class="list-tabs">
                <button class="tab-button" data-tab="moviesToWatch">
                    <svg viewBox="0 0 24 24"><path d="M2,6V20H16V22H18V20H22V6H2M16,11H13V8H11V11H8V13H11V16H13V13H16V11M20,18H4V8H20V18Z" /></svg>
                    <span>Filmy do obejrzenia</span>
                </button>
                <button class="tab-button" data-tab="moviesWatched">
                    <svg viewBox="0 0 24 24"><path d="M4,6H2V20A2,2 0 0,0 4,22H18V20H4V6M20,2H8A2,2 0 0,0 6,4V16A2,2 0 0,0 8,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M12.4,14L10,11.6L11.4,10.2L12.4,11.2L15.6,8L17,9.4L12.4,14Z" /></svg>
                    <span>Filmy obejrzane</span>
                </button>
                 <button class="tab-button" data-tab="seriesToWatch">
                    <svg viewBox="0 0 24 24"><path d="M21,17H3V5H21M21,3H3A2,2 0 0,0 1,5V17A2,2 0 0,0 3,19H8V21H16V19H21A2,2 0 0,0 23,17V5A2,2 0 0,0 21,3M16,11H13V8H11V11H8V13H11V16H13V13H16V11Z" /></svg>
                    <span>Seriale do obejrzenia</span>
                </button>
                <button class="tab-button" data-tab="seriesWatched">
                    <svg viewBox="0 0 24 24"><path d="M21,3H3A2,2 0 0,0 1,5V17A2,2 0 0,0 3,19H8V21H16V19H21A2,2 0 0,0 23,17V5A2,2 0 0,0 21,3M11.29,15.29L7.8,11.8L9.21,10.38L11.29,12.46L15.25,8.5L16.67,9.92L11.29,15.29Z" /></svg>
                    <span>Seriale obejrzane</span>
                </button>
            </div>
             <div id="searchResults"></div>
        </div>
    </header>

    <main id="app">
        <div id="configSection"></div>
        <div id="mainContent" style="display: none;">
            <div id="lists-section">
                <div id="moviesToWatchListContainer" class="list-container active"></div>
                <div id="moviesWatchedListContainer" class="list-container"></div>
                <div id="seriesToWatchListContainer" class="list-container"></div>
                <div id="seriesWatchedListContainer" class="list-container"></div>
            </div>
        </div>
    </main>

    <button id="info-fab" class="icon-button" title="O aplikacji">
        <svg viewBox="0 0 24 24"><path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" /></svg>
    </button>
    <div id="detailsModalContainer"></div>
    <div id="actorModalContainer"></div>
    <div id="customAlertContainer"></div>

    <script>
        const applyTheme = () => {
            const storedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = storedTheme || (systemPrefersDark ? 'dark' : 'light');

            document.body.dataset.theme = theme;
            document.getElementById('theme-toggle').innerHTML = theme === 'dark' ? ICONS.sun : ICONS.moon;

            document.getElementById('color-scheme-meta').setAttribute('content', theme);
            const themeColor = theme === 'dark' ? '#101114' : '#f0f2f5';
            document.getElementById('theme-color-meta').setAttribute('content', themeColor);
        };

        const toggleTheme = () => {
            const currentTheme = document.body.dataset.theme;
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.body.dataset.theme = newTheme;
            localStorage.setItem('theme', newTheme);
            document.getElementById('theme-toggle').innerHTML = newTheme === 'dark' ? ICONS.sun : ICONS.moon;

            document.getElementById('color-scheme-meta').setAttribute('content', newTheme);
            const themeColor = newTheme === 'dark' ? '#101114' : '#f0f2f5';
            document.getElementById('theme-color-meta').setAttribute('content', themeColor);
        };

        const API_BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const POSTER_PLACEHOLDER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 300'%3E%3Crect width='200' height='300' fill='%23202227'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%238e9297' font-size='18' font-family='sans-serif'%3EBrak okładki%3C/text%3E%3C/svg%3E";

        let API_KEY = '';
        let data = { moviesToWatch: [], moviesWatched: [], seriesToWatch: [], seriesWatched: [] };
        let viewState = {
            activeTab: 'moviesToWatch',
            moviesToWatch: { sortBy: 'dateAdded_desc', filterByGenre: 'all', filterFavoritesOnly: false },
            moviesWatched: { sortBy: 'dateAdded_desc', filterByGenre: 'all', filterFavoritesOnly: false },
            seriesToWatch: { sortBy: 'dateAdded_desc', filterByGenre: 'all', filterFavoritesOnly: false },
            seriesWatched: { sortBy: 'dateAdded_desc', filterByGenre: 'all', filterFavoritesOnly: false },
        };
        const LIST_NAMES = {
            moviesToWatch: 'Filmy do Obejrzenia',
            moviesWatched: 'Filmy Obejrzane',
            seriesToWatch: 'Seriale do Obejrzenia',
            seriesWatched: 'Seriale Obejrzane',
        };
        const ICONS = {
            sun: `<svg viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45 1 1zM5.64 5.64c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 2.81c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.42zm12.72 12.72c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41zM4.22 18.36c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41zm14.14-14.14c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.41-1.41c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.41 1.41z"/></svg>`,
            moon: `<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.62-.14 2.37-.38-.43-.97-.7-2.13-.7-3.37 0-3.68 2.5-6.8 5.86-7.82C18.17 4.19 15.21 3 12 3z"/></svg>`,
            person: `<svg class="placeholder-svg" viewBox="0 0 24 24"><path d="M12,19.2C9.5,19.2 7.29,17.92 6,16C6.03,14 10,12.9 12,12.9C14,12.9 17.97,14 18,16C16.71,17.92 14.5,19.2 12,19.2M12,5A3,3 0 0,1 15,8A3,3 0 0,1 12,11A3,3 0 0,1 9,8A3,3 0 0,1 12,5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>`
        };

        const db = {
            _db: null, _dbName: 'PenguinFlixDB', _storeName: 'appState',
            async open() { if (this._db) return this._db; return new Promise((resolve, reject) => { const request = indexedDB.open(this._dbName, 1); request.onupgradeneeded = (event) => { const db = event.target.result; if (!db.objectStoreNames.contains(this._storeName)) { db.createObjectStore(this._storeName); } }; request.onsuccess = (event) => { this._db = event.target.result; resolve(this._db); }; request.onerror = (event) => { console.error('Błąd otwierania IndexedDB:', event.target.error); reject(event.target.error); }; }); },
            async set(key, value) { const db = await this.open(); return new Promise((resolve, reject) => { const transaction = db.transaction(this._storeName, 'readwrite'); const store = transaction.objectStore(this._storeName); store.put(value, key); transaction.oncomplete = () => resolve(true); transaction.onerror = (event) => reject(event.target.error); }); },
            async get(key) { const db = await this.open(); return new Promise((resolve, reject) => { const transaction = db.transaction(this._storeName, 'readonly'); const store = transaction.objectStore(this._storeName); const request = store.get(key); request.onsuccess = () => resolve(request.result); request.onerror = (event) => reject(event.target.error); }); }
        };

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            API_KEY = localStorage.getItem('tmdbApiKey');
            if (API_KEY) {
                showMainContent();
                await loadData();
                applyTheme();
                switchActiveList(viewState.activeTab || 'moviesToWatch');
            } else {
                showConfig();
            }
            setupEventListeners();
        }

        function switchActiveList(listId) {
            viewState.activeTab = listId;
            document.querySelectorAll('.list-container').forEach(c => c.classList.remove('active'));
            document.getElementById(`${listId}ListContainer`).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === listId);
            });

            renderList(data[listId] || [], listId);
        }

        function renderList(originalItems, listId) {
            const container = document.getElementById(`${listId}ListContainer`);
            if (!container) return;
            const state = viewState[listId];
            let itemsToRender = [...(originalItems || [])];

            if (state.filterFavoritesOnly) {
                itemsToRender = itemsToRender.filter(item => item.isFavorite);
            }
            if (state.filterByGenre !== 'all') {
                itemsToRender = itemsToRender.filter(item => item.genres.includes(state.filterByGenre));
            }

            const [sortBy, direction] = state.sortBy.split('_');
            itemsToRender.sort((a, b) => {
                let valA, valB;
                switch (sortBy) {
                    case 'title': valA = a.title || ''; valB = b.title || ''; return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    case 'year': case 'rating': case 'dateAdded': valA = a[sortBy] || 0; valB = b[sortBy] || 0; return direction === 'asc' ? valA - valB : valB - valA;
                    default: return 0;
                }
            });

            const listHTML = itemsToRender.map(item => {
                const isWatched = listId.includes('Watched');
                let extraInfo = '';

                if (isWatched && item.rating) {
                    extraInfo = generateStarRatingDisplay(item.rating);
                } else if (listId === 'seriesToWatch' && item.progress && item.numberOfEpisodes > 0) {
                    const watchedCount = Object.values(item.progress).reduce((acc, eps) => acc + eps.length, 0);
                    const progressPercent = (watchedCount / item.numberOfEpisodes) * 100;
                    extraInfo = `
                        <div class="progress-container">
                            <div class="progress-text">Obejrzano: ${watchedCount} / ${item.numberOfEpisodes}</div>
                            <div class="progress-bar"><div class="progress-bar-inner" style="width: ${progressPercent}%;"></div></div>
                        </div>
                    `;
                }

                return `
                    <li class="list-item" data-id="${item.id}" data-type="${item.type}">
                        <img src="${item.poster || POSTER_PLACEHOLDER}" alt="Okładka" onerror="this.onerror=null; this.src='${POSTER_PLACEHOLDER}';">
                        <div class="info">
                            <strong>${item.title}</strong>
                            <span class="meta">${item.year}</span>
                            <p class="overview">${item.overview || ''}</p>
                            ${extraInfo}
                        </div>
                        <div class="item-actions">
                            <button class="icon-button delete-btn" title="Usuń">
                                <svg viewBox="0 0 24 24"><path d="M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19M8,9H16V19H8V9M15.5,4L14.5,3H9.5L8.5,4H5V6H19V4H15.5Z"/></svg>
                            </button>
                        </div>
                    </li>`;
            }).join('');

            const sortOptionsActive = state.sortBy !== 'dateAdded_desc' ? 'active' : '';
            const filterOptionsActive = (state.filterByGenre !== 'all' || state.filterFavoritesOnly) ? 'active' : '';

            container.innerHTML = `
                <div class="view-controls">
                    <button class="button ${sortOptionsActive}" data-action="open-sort-options">
                        <svg viewBox="0 0 24 24"><path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/></svg>
                        <span>Sortuj</span>
                    </button>
                    <button class="button ${filterOptionsActive}" data-action="open-filter-options">
                       <svg viewBox="0 0 24 24"><path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/></svg>
                       <span>Filtruj</span>
                    </button>
                </div>
                <ul>${itemsToRender.length > 0 ? listHTML : `<div class="placeholder" style="padding:40px 0; color:var(--text-secondary); text-align:center;">Brak pozycji do wyświetlenia.</div>`}</ul>`;
        }

        function setupEventListeners() {
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('custom-add-btn').addEventListener('click', openCustomAddModal);
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => debouncedSearch(e.target.value.trim()));
            searchInput.addEventListener('focus', () => { if(searchInput.value) document.getElementById('searchResults').style.display = 'block'; });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-wrapper') && !e.target.closest('#searchResults')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });
            document.getElementById('searchResults').addEventListener('click', handleAddItemClick);

            document.querySelector('.list-tabs').addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-button');
                if (tabButton) {
                    switchActiveList(tabButton.dataset.tab);
                }
            });

            document.getElementById('lists-section').addEventListener('click', (e) => {
                const actionBtn = e.target.closest('[data-action]');
                if (actionBtn) {
                    const action = actionBtn.dataset.action;
                    if (action === 'open-sort-options') openSortModal();
                    else if (action === 'open-filter-options') openFilterModal();
                } else if (e.target.closest('.list-item')) {
                    handleListActions(e);
                }
            });

            document.getElementById('backupButton').addEventListener('click', backupData);
            document.getElementById('restoreInput').addEventListener('change', restoreData);
            document.getElementById('info-fab').addEventListener('click', showInfoModal);
        }

        async function openSortModal() {
            const listId = viewState.activeTab; const state = viewState[listId]; const isWatched = listId.includes('Watched');
            const sortOptions = [{ value: 'dateAdded_desc', label: 'Data dodania (najnowsze)' }, { value: 'dateAdded_asc', label: 'Data dodania (najstarsze)' }, { value: 'title_asc', label: 'Tytuł (A-Z)' }, { value: 'title_desc', label: 'Tytuł (Z-A)' }, { value: 'year_desc', label: 'Rok (najnowsze)' }, { value: 'year_asc', label: 'Rok (najstarsze)' }];
            if (isWatched) { sortOptions.push({ value: 'rating_desc', label: 'Ocena (najwyższa)' }, { value: 'rating_asc', label: 'Ocena (najniższa)' }); }
            const sortOptionsHTML = sortOptions.map(opt => `<label><input type="radio" name="sort" value="${opt.value}" ${state.sortBy === opt.value ? 'checked' : ''}> ${opt.label}</label>`).join('');
            const modalContainer = document.getElementById('detailsModalContainer');
            modalContainer.innerHTML = `<div class="modal-overlay"><div class="control-modal-content"><h3>Sortuj według</h3><div class="control-modal-options">${sortOptionsHTML}</div><div class="control-modal-footer"><button class="reset-btn">Resetuj</button><button class="apply-btn">Zastosuj</button></div></div></div>`;
            modalContainer.querySelector('.modal-overlay').onclick = e => { if (e.target.classList.contains('modal-overlay')) modalContainer.innerHTML = ''; };
            modalContainer.querySelector('.apply-btn').onclick = async () => {
                const selectedSort = document.querySelector('input[name="sort"]:checked'); if (selectedSort) state.sortBy = selectedSort.value;
                await saveData(); renderList(data[listId], listId); modalContainer.innerHTML = '';
            };
            modalContainer.querySelector('.reset-btn').onclick = async () => {
                state.sortBy = 'dateAdded_desc';
                await saveData(); renderList(data[listId], listId); modalContainer.innerHTML = '';
            };
        }

        async function openFilterModal() {
            const listId = viewState.activeTab; const state = viewState[listId];
            const uniqueGenres = [...new Set((data[listId] || []).flatMap(item => item.genres))].sort();

            let filterOptionsHTML = `
                <div>
                    <label style="display: flex; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);">
                        <input type="checkbox" id="filter-favorites-checkbox" ${state.filterFavoritesOnly ? 'checked' : ''}>
                        Pokaż tylko ulubione
                    </label>
                </div>
                <div style="margin-top: 16px;">
                    <label><input type="radio" name="genre-filter" value="all" ${state.filterByGenre === 'all' ? 'checked' : ''}> Wszystkie gatunki</label>
            `;

            if (uniqueGenres.length > 0) {
                 filterOptionsHTML += uniqueGenres.map(genre => `<label><input type="radio" name="genre-filter" value="${genre}" ${state.filterByGenre === genre ? 'checked' : ''}> ${genre}</label>`).join('');
            }
            filterOptionsHTML += `</div>`;

            const modalContainer = document.getElementById('detailsModalContainer');
            modalContainer.innerHTML = `<div class="modal-overlay"><div class="control-modal-content"><h3>Filtruj</h3><div class="control-modal-options">${filterOptionsHTML}</div><div class="control-modal-footer"><button class="reset-btn">Resetuj</button><button class="apply-btn">Zastosuj</button></div></div></div>`;
            modalContainer.querySelector('.modal-overlay').onclick = e => { if (e.target.classList.contains('modal-overlay')) modalContainer.innerHTML = ''; };
            modalContainer.querySelector('.apply-btn').onclick = async () => {
                state.filterFavoritesOnly = document.getElementById('filter-favorites-checkbox').checked;
                const selectedGenre = document.querySelector('input[name="genre-filter"]:checked');
                if (selectedGenre) state.filterByGenre = selectedGenre.value;
                await saveData(); renderList(data[listId], listId); modalContainer.innerHTML = '';
            };
            modalContainer.querySelector('.reset-btn').onclick = async () => {
                state.filterFavoritesOnly = false;
                state.filterByGenre = 'all';
                await saveData(); renderList(data[listId], listId); modalContainer.innerHTML = '';
            };
        }

        function showInfoModal() {
            const infoHTML = `
                <div class="modal-overlay" id="infoModal">
                    <div class="modal-content">
                        <button class="icon-button modal-top-close-btn" title="Zamknij">
                            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                        <h2>
                            <svg class="app-logo-icon" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M401.7,144.2C382.4,106.6,343.3,80,299.7,80c-48.5,0-88.7,35.5-96.8,81.4c-42.5,0-76.8,34.4-76.8,76.8 c0,35.1,22.4,64.8,53.2,73.8c-7.3,4.4-15.6,6.9-24.4,6.9c-32.1,0-58.1,26-58.1,58.1h29.1c0-16,13-29.1,29.1-29.1 s29.1,13,29.1,29.1h29.1h29.1h29.1c0-16,13-29.1,29.1-29.1s29.1,13,29.1,29.1h29.1c0-32.1-26-58.1-58.1-58.1 c-8.8,0-17.1,2.5-24.4-6.9c30.8-9,53.2-38.7,53.2-73.8C478.5,178.6,444.2,144.2,401.7,144.2z M241.6,220.3 c-12,0-21.8-9.8-21.8-21.8s9.8-21.8,21.8-21.8s21.8,9.8,21.8,21.8S253.6,220.3,241.6,220.3z M358.4,220.3 c-12,0-21.8-9.8-21.8-21.8s9.8-21.8,21.8-21.8s21.8,9.8,21.8,21.8S370.4,220.3,358.4,220.3z"/></svg>
                            <span>PenguinFlix</span>
                        </h2>
                        <p style="color: var(--text-secondary);">Twój osobisty dziennik do śledzenia filmów i seriali.</p>
                        <h3>Kluczowe Funkcje</h3>
                        <ul style="text-align: left; list-style-position: inside; display: block;">
                            <li>Śledzenie tytułów do obejrzenia i już obejrzanych</li>
                            <li>Osobne listy dla filmów i seriali</li>
                            <li>Ocenianie i dodawanie recenzji</li>
                            <li>Błyskawiczne wyszukiwanie w ogromnej bazie filmów</li>
                        </ul>
                        <h3>Twoje Dane i Kopie Zapasowe</h3>
                        <div class="important-note">
                            <strong>Ważne:</strong> Wszystkie Twoje dane są przechowywane <strong>wyłącznie w przeglądarce na tym urządzeniu</strong>. Nie są wysyłane na żaden serwer.
                            <br><br>
                            Aby uniknąć utraty danych (np. po wyczyszczeniu danych przeglądarki lub zmianie urządzenia), <strong>regularnie twórz kopię zapasową</strong> za pomocą przycisku eksportu (ikona strzałki w dół) w nagłówku.
                        </div>
                        <p style="font-size: 0.8rem; color: var(--text-secondary);">
                            Ta aplikacja wykorzystuje dane i obrazy dostarczane przez The Movie Database (TMDb).
                            <br>
                            <img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_short-8e7b30f73a4020692ccca9c88bafe5dcb6f8a62a4c6bc55cd9ba82bb2cd95f6c.svg" alt="TMDb Logo" class="tmdb-logo">
                        </p>
                    </div>
                </div>`;
            const customAlertContainer = document.getElementById('customAlertContainer');
            customAlertContainer.innerHTML = infoHTML;
            const modal = customAlertContainer.querySelector('.modal-overlay');
            const closeBtn = modal.querySelector('.modal-top-close-btn');
            const closeModal = () => customAlertContainer.innerHTML = '';
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
            closeBtn.addEventListener('click', closeModal);
        }

        const generateStarRatingDisplay = (rating) => { let starsHTML = ''; const starPath = "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"; for (let i = 1; i <= 5; i++) { if (rating >= i) { starsHTML += `<svg viewBox="0 0 24 24" fill="var(--warning-color)"><path d="${starPath}"/></svg>`; } else if (rating >= i - 0.5) { starsHTML += `<svg viewBox="0 0 24 24"><defs><linearGradient id="half_grad_${i}" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="50%" stop-color="var(--warning-color)"/><stop offset="50%" stop-color="var(--border-color)"/></linearGradient></defs><path d="${starPath}" fill="url(#half_grad_${i})"/></svg>`; } else { starsHTML += `<svg viewBox="0 0 24 24" fill="var(--border-color)"><path d="${starPath}"/></svg>`; } } return `<div class="star-rating-display">${starsHTML}</div>`; };
        const getListAndItem = (id, type) => { for (const listName in data) { if(Array.isArray(data[listName])) { const item = data[listName].find(i => String(i.id) === String(id) && i.type === type); if (item) return { listName, item }; } } return { listName: null, item: null }; };
        const showMainContent = () => { document.getElementById('configSection').style.display = 'none'; document.getElementById('mainContent').style.display = 'block'; };
        const showConfig = () => { document.getElementById('mainContent').style.display = 'none'; const configSection = document.getElementById('configSection'); configSection.style.display = 'block'; configSection.innerHTML = `<div style="max-width:800px; margin:24px auto; background-color: var(--card-color); padding: 24px; border-radius: var(--radius-lg); text-align: center;"><h2>Konfiguracja</h2><p style="color: var(--text-secondary); max-width: 400px; margin: 16px auto;">Wklej poniżej swój klucz API z The Movie Database (TMDb), aby rozpocząć.</p><div style="display: flex; gap: 10px; margin-top: 20px;"><input type="text" id="apiKeyInput" placeholder="Twój klucz API (v3 auth)" style="flex-grow:1; padding:15px; background-color: color-mix(in srgb, var(--bg-color) 50%, var(--card-color)); color:var(--text-color); border:1px solid var(--border-color); border-radius:var(--radius-md); font-size: 1em;"><button id="saveApiKeyButton" style="padding:15px 20px; border:none; background:var(--primary-color); color:white; border-radius:var(--radius-md); cursor:pointer; font-weight:bold;">Zapisz</button></div></div>`; document.getElementById('saveApiKeyButton').addEventListener('click', () => { const key = document.getElementById('apiKeyInput').value.trim(); if (key) { localStorage.setItem('tmdbApiKey', key); API_KEY = key; showCustomAlert('Sukces!', 'Klucz API został zapisany.', 'success'); init(); } else { showCustomAlert('Błąd', 'Proszę wprowadzić prawidłowy klucz API.', 'error'); } }); };
        const showCustomAlert = (title, message, type = 'info') => { const icons = { success: `<svg viewBox="0 0 52 52" style="width:60px;margin-bottom:16px;"><circle cx="26" cy="26" r="25" fill="none" stroke="var(--success-color)" stroke-width="4"/><path fill="none" stroke="var(--success-color)" stroke-width="4" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg>`, error: `<svg viewBox="0 0 52 52" style="width:60px;margin-bottom:16px;"><circle cx="26" cy="26" r="25" fill="none" stroke="var(--primary-color)" stroke-width="4"/><path fill="none" stroke="var(--primary-color)" stroke-width="4" d="M16 16 36 36 M36 16 16 36"/></svg>`, }; const alertHTML = `<div class="modal-overlay" id="customAlert"><div class="modal-content">${icons[type] || ''}<h2>${title}</h2><p>${message}</p><div class="alert-button-group"><button class="alert-button-confirm" style="padding:12px 24px;border:none;border-radius:var(--radius-md);font-weight:bold;cursor:pointer;background:var(--primary-color);color:white;">OK</button></div></div></div>`; const customAlertContainer = document.getElementById('customAlertContainer'); customAlertContainer.innerHTML = alertHTML; customAlertContainer.querySelector('.alert-button-confirm').onclick = () => customAlertContainer.innerHTML = ''; };
        const showCustomConfirm = (title, message) => { return new Promise((resolve) => { const confirmHTML = `<div class="modal-overlay" id="customAlert"><div class="modal-content"><h2>${title}</h2><p>${message}</p><div class="alert-button-group" style="display:flex;justify-content:center;gap:12px;margin-top:24px;"><button class="alert-button-cancel" style="padding:12px 24px;border:none;border-radius:var(--radius-md);font-weight:bold;cursor:pointer;background-color: var(--border-color);color:var(--text-color);">Anuluj</button><button class="alert-button-confirm" style="padding:12px 24px;border:none;border-radius:var(--radius-md);font-weight:bold;cursor:pointer;background:var(--primary-color);color:white;">Potwierdź</button></div></div></div>`; const customAlertContainer = document.getElementById('customAlertContainer'); customAlertContainer.innerHTML = confirmHTML; customAlertContainer.querySelector('.alert-button-confirm').onclick = () => { customAlertContainer.innerHTML = ''; resolve(true); }; customAlertContainer.querySelector('.alert-button-cancel').onclick = () => { customAlertContainer.innerHTML = ''; resolve(false); }; }); };
        const debounce = (func, delay) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), delay) } };
        const debouncedSearch = debounce(async (query) => { const searchResults = document.getElementById('searchResults'); if (!query) { searchResults.style.display = 'none'; return; } searchResults.style.display = 'block'; searchResults.innerHTML = `<div class="placeholder" style="padding:20px; text-align:center;">Wyszukiwanie...</div>`; try { const response = await fetch(`${API_BASE_URL}/search/multi?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=pl-PL&include_adult=false`); if (!response.ok) throw new Error(response.status === 401 ? 'Nieprawidłowy klucz API.' : 'Błąd sieci.'); const resData = await response.json(); displaySearchResults(resData.results); } catch (error) { searchResults.innerHTML = `<div class="placeholder" style="padding:20px;text-align:center;color:var(--primary-color);">${error.message}</div>`; } }, 400);
        const displaySearchResults = (results) => { const searchResults = document.getElementById('searchResults'); searchResults.innerHTML = ''; const validResults = results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path).slice(0, 5); if (validResults.length === 0) { searchResults.innerHTML = '<div class="placeholder" style="padding:20px; text-align:center;">Brak wyników.</div>'; return; } validResults.forEach(item => { const div = document.createElement('div'); div.className = 'search-item'; const posterSrc = item.poster_path ? IMAGE_BASE_URL.replace('w500', 'w200') + item.poster_path : POSTER_PLACEHOLDER; div.innerHTML = `<img src="${posterSrc}" alt="Okładka" loading="lazy" onerror="this.onerror=null; this.src='${POSTER_PLACEHOLDER}';"><div class="info"><strong>${item.title || item.name}</strong><span>${(item.release_date || item.first_air_date || '').substring(0, 4)}</span></div><div class="actions"><button class="icon-button add-item" data-id="${item.id}" data-type="${item.media_type}" data-list="toWatch" title="Dodaj do obejrzenia"><svg viewBox="0 0 24 24"><path d="M17,3A2,2 0 0,1 19,5V21L12,18L5,21V5C5,3.89 5.9,3 7,3H17M11,14H9V12H11V14M15,14H13V12H15V14M11,10H9V8H11V10M15,10H13V8H15V10Z"/></svg></button><button class="icon-button add-item" data-id="${item.id}" data-type="${item.media_type}" data-list="watched" title="Dodaj do obejrzanych"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,16.5L6.5,12L7.91,10.59L11,13.67L16.09,8.59L17.5,10L11,16.5Z"/></svg></button></div>`; searchResults.appendChild(div); }); };
        async function handleAddItemClick(e) { const button = e.target.closest('.add-item'); if (!button) return; button.disabled = true; const { id, type, list } = button.dataset; const alreadyExists = Object.values(data).flat().some(item => String(item.id) === String(id) && item.type === type); if (alreadyExists) { showCustomAlert('Informacja', 'Ten tytuł już jest na jednej z list.', 'error'); button.disabled = false; return; } const itemDetails = await getItemDetails(id, type); if (!itemDetails) { showCustomAlert('Błąd', 'Nie udało się pobrać szczegółów tytułu.', 'error'); button.disabled = false; return; } itemDetails.dateAdded = Date.now(); const targetListName = `${type === 'movie' ? 'movies' : 'series'}${list === 'toWatch' ? 'ToWatch' : 'Watched'}`; if (list === 'watched') { itemDetails.rating = null; itemDetails.review = ""; } data[targetListName].unshift(itemDetails); await saveData(); switchActiveList(viewState.activeTab); document.getElementById('searchInput').value = ''; document.getElementById('searchResults').style.display = 'none'; showCustomAlert('Sukces!', 'Dodano do listy!', 'success'); }
        async function getItemDetails(id, type) { try { const response = await fetch(`${API_BASE_URL}/${type}/${id}?api_key=${API_KEY}&language=pl-PL&append_to_response=images&include_image_language=pl,en,null`); if (!response.ok) return null; const d = await response.json(); const item = { id: d.id, title: d.title || d.name, poster: d.poster_path ? IMAGE_BASE_URL + d.poster_path : null, type: type, year: (d.release_date || d.first_air_date || '').substring(0, 4), overview: d.overview, genres: d.genres.map(g => g.name), isFavorite: false }; if (type === 'tv') { item.seasons = d.seasons; item.numberOfSeasons = d.number_of_seasons; item.numberOfEpisodes = d.number_of_episodes; item.progress = {}; } return item; } catch { return null; } }
        async function getCredits(id, type) { if (String(id).startsWith('custom_')) return []; try { const response = await fetch(`${API_BASE_URL}/${type}/${id}/credits?api_key=${API_KEY}&language=pl-PL`); if (!response.ok) return []; const data = await response.json(); return data.cast.slice(0, 15); } catch { return []; } }

        async function handleListActions(e) {
            const itemElement = e.target.closest('.list-item');
            if (!itemElement) return;

            const id = itemElement.dataset.id;
            const type = itemElement.dataset.type;
            const deleteBtn = e.target.closest('.delete-btn');

            if (deleteBtn) {
                e.stopPropagation();
                const { listName } = getListAndItem(id, type);
                const confirmed = await showCustomConfirm('Potwierdzenie', 'Czy na pewno chcesz usunąć ten tytuł?');
                if (confirmed && listName) {
                    data[listName] = data[listName].filter(i => !(String(i.id) === String(id) && i.type === type));
                    await saveData();
                    renderList(data[listName], listName);
                    showCustomAlert('Usunięto', 'Tytuł został usunięty z listy.', 'success');
                }
            } else {
                openDetailsModal(id, type);
            }
        }

        async function handleMoveItem(id, type) { const fromListName = `${type === 'movie' ? 'movies' : 'series'}ToWatch`; const toListName = `${type === 'movie' ? 'movies' : 'series'}Watched`; const itemIndex = data[fromListName].findIndex(i => String(i.id) === String(id) && i.type == type); if (itemIndex > -1) { const [item] = data[fromListName].splice(itemIndex, 1); item.rating = null; item.review = ""; delete item.progress; delete item.seasons; data[toListName].unshift(item); await saveData(); switchActiveList(viewState.activeTab); showCustomAlert('Przeniesiono', 'Tytuł oznaczono jako obejrzany.', 'success'); } }
        async function saveData() { try { await db.set('mainState', { data, viewState }); } catch (error) { console.error("Nie udało się zapisać danych w IndexedDB:", error); showCustomAlert('Błąd Krytyczny', 'Nie można zapisać danych. Spróbuj odświeżyć stronę.', 'error'); } }
        async function loadData() {
            let savedState = await db.get('mainState');
            if (savedState) {
                data = savedState.data || data;
                viewState = savedState.viewState || viewState;
            } else {
                const oldStateStr = localStorage.getItem('penguinFlixData_v2') || localStorage.getItem('penguinFlixData_v1') || localStorage.getItem('cineLogData_v12');
                if (oldStateStr) {
                    try {
                        const oldState = JSON.parse(oldStateStr);
                        data = oldState.data || oldState || data;
                        viewState = oldState.viewState || viewState;
                        console.log('Znaleziono stare dane w localStorage, migrowanie do IndexedDB...');
                        await saveData();
                        localStorage.removeItem('penguinFlixData_v2');
                        localStorage.removeItem('penguinFlixData_v1');
                        localStorage.removeItem('cineLogData_v12');
                    } catch (e) { console.error('Błąd parsowania starych danych z localStorage', e); }
                }
            }
            // ZMIANA: Wywołanie funkcji migracji danych po ich wczytaniu
            migrateData(data);
        }

        // ZMIANA: Nowa funkcja do migracji/naprawiania danych
        function migrateData(dataToMigrate) {
            Object.keys(dataToMigrate).forEach(key => {
                if(Array.isArray(dataToMigrate[key])) {
                    dataToMigrate[key].forEach(item => {
                        // Istniejące migracje
                        if (item.dateAdded === undefined) item.dateAdded = Date.now() - Math.floor(Math.random()*100000);
                        if (item.isFavorite === undefined) item.isFavorite = false;

                        // Nowa migracja dla ścieżek do plakatów
                        if (item.poster && item.poster.startsWith('/')) {
                            item.poster = IMAGE_BASE_URL + item.poster;
                        }
                    });
                }
            });

            Object.keys(viewState).forEach(key => {
                const state = viewState[key];
                if (typeof state === 'object' && state !== null) {
                    if (state.hasOwnProperty('filterBy')) {
                        state.filterByGenre = state.filterBy === 'favorites' ? 'all' : state.filterBy;
                        state.filterFavoritesOnly = state.filterBy === 'favorites';
                        delete state.filterBy;
                    }
                    if (state.filterFavoritesOnly === undefined) state.filterFavoritesOnly = false;
                    if (state.filterByGenre === undefined) state.filterByGenre = 'all';
                }
            });
        }

        function isDataEmpty() { return Object.values(data).every(list => !list || list.length === 0); }
        function backupData() { if (isDataEmpty()) { showCustomAlert('Informacja', 'Brak danych do utworzenia kopii zapasowej.', 'info'); return; } const dataStr = JSON.stringify({ data, viewState }, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `penguinflix_backup_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(a.href); }
        async function restoreData(e) { const file = e.target.files[0]; if (!file) return; const confirmed = await showCustomConfirm('Przywracanie kopii', 'Spowoduje to nadpisanie wszystkich obecnych danych. Kontynuować?'); if (!confirmed) { e.target.value = ''; return; } const reader = new FileReader(); reader.onload = async (event) => { try { const restored = JSON.parse(event.target.result); if (restored.data && restored.data.moviesToWatch !== undefined) {
            // ZMIANA: Wywołanie funkcji migracji na wczytanych danych PRZED zapisaniem i wyświetleniem
            migrateData(restored.data);

            data = restored.data;
            viewState = restored.viewState || viewState;
            await saveData();
            switchActiveList(viewState.activeTab || 'moviesToWatch');
            showCustomAlert('Sukces', 'Dane zostały przywrócone.', 'success');
            } else { throw new Error('Nieprawidłowy format pliku.'); } } catch(err) { showCustomAlert('Błąd', err.message || 'Błąd odczytu pliku.', 'error'); } }; reader.readAsText(file); e.target.value = ''; }

        async function populateAndRenderSeriesSections(item, container) {
            // If it's a custom entry, it won't have seasons.
            if (String(item.id).startsWith('custom_')) {
                 container.innerHTML = `<div class="seasons-section"><h3>Postęp oglądania</h3><p style="color: var(--text-secondary);">Śledzenie odcinków nie jest dostępne dla wpisów niestandardowych.</p></div>`;
                 return;
            }
            // If data from old backup is missing season info, fetch it now.
            if (!item.seasons) {
                container.innerHTML = `<div class="seasons-section"><h3>Postęp oglądania</h3><p class="loading-episodes">Aktualizowanie danych serialu...</p></div>`;
                const freshDetails = await getItemDetails(item.id, item.type);
                if (freshDetails) {
                    Object.assign(item, freshDetails); // Merge new data into the existing item
                    await saveData();
                } else {
                    container.innerHTML = `<div class="seasons-section"><h3>Postęp oglądania</h3><p style="color:var(--primary-color)">Nie udało się pobrać danych o sezonach.</p></div>`;
                    return;
                }
            }
            renderSeasonsProgress(item, container);
        }

        async function openDetailsModal(id, type) {
            const { listName, item } = getListAndItem(id, type);
            if (!item) return;
            const isToWatchSeries = listName === 'seriesToWatch';
            const isWatched = listName.includes('Watched');
            const detailsModalContainer = document.getElementById('detailsModalContainer');
            const modalHTML = `<div class="modal-overlay"><div class="modal-content"><button class="icon-button modal-top-close-btn" title="Zamknij"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button><div class="modal-header"><img src="${item.poster || POSTER_PLACEHOLDER}" alt="Okładka" onerror="this.onerror=null; this.src='${POSTER_PLACEHOLDER}';"><div class="modal-title-wrapper"><div class="modal-title"><h2>${item.title} (${item.year})</h2><div class="genres">${(item.genres || []).map(g => `<span class="genre-tag">${g}</span>`).join('')}</div></div><button id="modal-favorite-btn" class="icon-button favorite-btn ${item.isFavorite ? 'active' : ''}" title="Oznacz jako ulubione"><svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/></svg></button></div></div><div class="modal-body"><h3>Opis</h3><p style="line-height:1.6;color:var(--text-secondary);">${item.overview || 'Brak opisu.'}</p><div id="seasons-container"></div><div id="cast-container"></div>${isWatched ? `<h3>Twoja ocena i recenzja</h3><div class="star-rating-interactive"></div><div class="rating-controls"><button id="rating-decrement" aria-label="Zmniejsz ocenę o pół gwiazdki">-</button><span id="rating-display" class="rating-display"></span><button id="rating-increment" aria-label="Zwiększ ocenę o pół gwiazdki">+</button></div><textarea id="reviewText" placeholder="Napisz swoją recenzję..." style="width:100%;min-height:120px;background:color-mix(in srgb, var(--bg-color) 50%, var(--card-color));border:1px solid var(--border-color);color:var(--text-color);border-radius:var(--radius-md);padding:14px;font-size:1rem;resize:vertical;">${item.review || ''}</textarea>` : ''}</div><div class="modal-footer" style="margin-top:24px;display:flex;justify-content:flex-end;">${isWatched ? `<button id="saveReviewBtn" style="padding:14px 24px;border:none;background:var(--primary-color);color:white;border-radius:var(--radius-md);cursor:pointer;font-size:1rem;font-weight:bold;">Zapisz zmiany</button>` : `<button id="moveToWatchedBtn" style="padding:14px 24px;border:none;background:var(--primary-color);color:white;border-radius:var(--radius-md);cursor:pointer;font-size:1rem;font-weight:bold;">Oznacz jako Obejrzane</button>`}</div></div></div>`;
            detailsModalContainer.innerHTML = modalHTML;
            const modal = detailsModalContainer.querySelector('.modal-overlay');

            const closeModal = () => { detailsModalContainer.innerHTML = ''; renderList(data[listName], listName); };
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { closeModal(); }
                const castMember = e.target.closest('.cast-member[data-actor-id]');
                if (castMember) { openActorDetailsModal(castMember.dataset.actorId); }
            });
            modal.querySelector('.modal-top-close-btn').addEventListener('click', closeModal);
            modal.querySelector('#modal-favorite-btn').addEventListener('click', async (e) => {
                item.isFavorite = !item.isFavorite;
                e.currentTarget.classList.toggle('active', item.isFavorite);
                await saveData();
            });

            const castContainer = document.getElementById('cast-container');
            getCredits(id, type).then(cast => {
                if (cast && cast.length > 0) {
                    castContainer.innerHTML = `<p style="color: var(--text-secondary); margin-top: 24px;">Ładowanie obsady...</p>`;
                    const castHTML = cast.map(member => `<div class="cast-member" data-actor-id="${member.id}"><img src="${IMAGE_BASE_URL.replace('w500', 'w200')}${member.profile_path}" alt="${member.name}" loading="lazy" onerror="this.outerHTML = ICONS.person;"><strong>${member.name}</strong><span>${member.character}</span></div>`).join('');
                    castContainer.innerHTML = `<div class="cast-section"><h3>Obsada</h3><div class="cast-scroller">${castHTML}</div></div>`;
                } else { castContainer.innerHTML = ''; }
            });

            if (isToWatchSeries) {
                populateAndRenderSeriesSections(item, document.getElementById('seasons-container'));
            }

            if (isWatched) {
                setupInteractiveStars(item);
                document.getElementById('saveReviewBtn').onclick = async () => {
                    const ratingEl = document.querySelector('.star-rating-interactive');
                    item.rating = ratingEl ? parseFloat(ratingEl.dataset.rating) : null;
                    item.review = document.getElementById('reviewText').value;
                    await saveData();
                    closeModal();
                    showCustomAlert('Zapisano!', 'Twoja ocena została zapisana.', 'success');
                };
            } else {
                document.getElementById('moveToWatchedBtn').onclick = async () => {
                    await handleMoveItem(id, type);
                    closeModal();
                };
            }
        }

        function renderSeasonsProgress(item, container) {
            if (!item.seasons || item.seasons.length === 0) {
                container.innerHTML = `<div class="seasons-section"><h3>Postęp oglądania</h3><p style="color: var(--text-secondary);">Brak informacji o sezonach dla tego serialu.</p></div>`;
                return;
            }
            if (!item.progress) item.progress = {};

            const seasonsHTML = item.seasons.map(season => {
                const watchedInSeason = item.progress[season.season_number]?.length || 0;
                return `
                    <div class="season-details" data-season-number="${season.season_number}">
                        <div class="season-summary">
                            <h4>${season.name}</h4>
                            <span class="season-progress">${watchedInSeason} / ${season.episode_count}</span>
                        </div>
                        <div class="episodes-list">
                            <div class="loading-episodes">Ładowanie odcinków...</div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="seasons-section"><h3>Postęp oglądania</h3>${seasonsHTML}</div>`;

            container.querySelectorAll('.season-summary').forEach(summary => {
                summary.addEventListener('click', async (e) => {
                    const seasonDetailsDiv = e.currentTarget.parentElement;
                    const episodesListDiv = seasonDetailsDiv.querySelector('.episodes-list');
                    const seasonNumber = seasonDetailsDiv.dataset.seasonNumber;

                    if (episodesListDiv.style.display === 'block') {
                        episodesListDiv.style.display = 'none';
                    } else {
                        episodesListDiv.style.display = 'block';
                        if (!episodesListDiv.dataset.loaded) {
                            const seasonData = await getSeasonDetails(item.id, seasonNumber);
                            if (seasonData && seasonData.episodes) {
                                renderEpisodes(item, seasonData, episodesListDiv);
                                episodesListDiv.dataset.loaded = 'true';
                            } else {
                                episodesListDiv.innerHTML = `<div class="loading-episodes" style="color: var(--primary-color)">Błąd ładowania odcinków.</div>`;
                            }
                        }
                    }
                });
            });
        }

        async function getSeasonDetails(seriesId, seasonNumber) {
            try {
                const response = await fetch(`${API_BASE_URL}/tv/${seriesId}/season/${seasonNumber}?api_key=${API_KEY}&language=pl-PL`);
                if (!response.ok) return null;
                return await response.json();
            } catch {
                return null;
            }
        }

        function renderEpisodes(item, seasonData, container) {
            const seasonNumber = seasonData.season_number;
            if (!item.progress[seasonNumber]) item.progress[seasonNumber] = [];

            const episodesHTML = seasonData.episodes.map(episode => {
                const isChecked = item.progress[seasonNumber].includes(episode.episode_number);
                const uniqueId = `s${seasonNumber}-ep${episode.episode_number}`;

                return `
                    <div class="episode-item">
                         <div class="episode-info">
                            <div class="episode-title-line">
                                <span class="episode-number">${episode.episode_number}.</span>
                                <span class="episode-title">${episode.name}</span>
                            </div>
                            <p class="episode-overview">${episode.overview || 'Brak opisu.'}</p>
                        </div>
                        <label class="episode-status-toggle" for="${uniqueId}">
                            <input type="checkbox" id="${uniqueId}" data-episode-number="${episode.episode_number}" ${isChecked ? 'checked' : ''}>
                            <svg class="icon icon-watched" viewBox="0 0 24 24"><path d="M12,4.5C7,4.5 2.73,7.61 1,12c1.73,4.39 6,7.5 11,7.5s9.27-3.11 11-7.5C21.27,7.61 17,4.5 12,4.5M12,17a5,5 0 1,1 0-10,5 5 0 0,1 0,10m0-8a3,3 0 1,0 0,6,3 3 0 0,0 0-6Z"/></svg>
                            <svg class="icon icon-unwatched" viewBox="0 0 24 24"><path d="M11.83,9.17C12.2,9.06 12.59,9 13,9a4,4 0 0,1 4,4c0,0.41-0.06,0.8-0.17,1.17L19.83,17.17C21.5,15.82 22.8,14 23.5,12C21.83,8.44 17.75,6 13,6c-1.55,0-3.04,0.33-4.38,0.9L11.83,9.17M13,4.5C18,4.5 22.27,7.61 24,12c-0.69,1.66-1.7,3.16-2.92,4.33L18.6,13.87C18.85,13.29 19,12.66 19,12a4,4 0 0,0-4-4c-0.66,0-1.29,0.15-1.87,0.4L10.6,5.92C11.39,4.72 12.56,4.5 13,4.5M3.27,4.27l1.59,1.59C3.15,7.45 1.83,9.53 1,12c1.83,3.56 5.75,6 10.5,6c1.76,0 3.44-0.44 5-1.18l2.18,2.18l1.41-1.41L4.68,2.86L3.27,4.27M7.53,9.8l1.55,1.55c-0.05,0.21-0.08,0.42-0.08,0.65a2.5,2.5 0 0,0 2.5,2.5c0.23,0 0.44-0.03 0.65-0.08l1.55,1.55C11.7,16.84 10.9,17 10,17a4.5,4.5 0 0,1-4.5-4.5c0-0.9,0.16-1.7,0.47-2.47Z"/></svg>
                        </label>
                    </div>
                `;
            }).join('');

            const allWatched = item.progress[seasonNumber].length === seasonData.episodes.length;
            container.innerHTML = `
                <div class="season-actions">
                    <button class="season-toggle-all-btn" data-action="toggle-all">${allWatched ? 'Odznacz wszystkie' : 'Zaznacz wszystkie'}</button>
                </div>
                ${episodesHTML}`;

            container.addEventListener('change', async e => {
                if (e.target.type === 'checkbox') {
                    const episodeNumber = parseInt(e.target.dataset.episodeNumber);
                    if (e.target.checked) {
                        if (!item.progress[seasonNumber].includes(episodeNumber)) {
                            item.progress[seasonNumber].push(episodeNumber);
                        }
                    } else {
                        item.progress[seasonNumber] = item.progress[seasonNumber].filter(ep => ep !== episodeNumber);
                    }
                    await saveData();
                    updateSeasonProgressUI(item, seasonNumber);
                }
            });

            container.querySelector('.season-toggle-all-btn').addEventListener('click', async e => {
                const btn = e.target;
                const allCheckboxes = container.querySelectorAll('input[type="checkbox"]');
                const shouldCheckAll = !allCheckboxes[0] || !allCheckboxes[0].checked;

                item.progress[seasonNumber] = shouldCheckAll ? seasonData.episodes.map(ep => ep.episode_number) : [];
                allCheckboxes.forEach(cb => cb.checked = shouldCheckAll);

                await saveData();
                updateSeasonProgressUI(item, seasonNumber);
                btn.textContent = shouldCheckAll ? 'Odznacz wszystkie' : 'Zaznacz wszystkie';
            });
        }

        function updateSeasonProgressUI(item, seasonNumber) {
            const seasonDetailsDiv = document.querySelector(`.season-details[data-season-number="${seasonNumber}"]`);
            if (seasonDetailsDiv) {
                const progressSpan = seasonDetailsDiv.querySelector('.season-progress');
                const totalEpisodesInSeason = progressSpan.textContent.split('/')[1].trim();
                const watchedCount = item.progress[seasonNumber]?.length || 0;
                progressSpan.textContent = `${watchedCount} / ${totalEpisodesInSeason}`;
            }
        }

        function openCustomAddModal() {
            const modalHTML = `
                <div class="modal-overlay" id="customAddModal">
                    <div class="modal-content">
                        <h3>Dodaj wpis ręcznie</h3>
                        <form id="custom-add-form">
                            <input type="text" id="custom-title" placeholder="Tytuł (wymagane)" required>
                            <input type="number" id="custom-year" placeholder="Rok produkcji (np. 2023)">
                            <input type="text" id="custom-poster" placeholder="URL do plakatu (opcjonalnie)">
                            <div>
                                <p style="margin: 0 0 8px; font-weight: 600;">Typ:</p>
                                <div class="radio-group">
                                    <label><input type="radio" name="custom-type" value="movie" checked> Film</label>
                                    <label><input type="radio" name="custom-type" value="tv"> Serial</label>
                                </div>
                            </div>
                            <div>
                                <p style="margin: 0 0 8px; font-weight: 600;">Dodaj do listy:</p>
                                <div class="radio-group">
                                    <label><input type="radio" name="custom-list" value="ToWatch" checked> Do obejrzenia</label>
                                    <label><input type="radio" name="custom-list" value="Watched"> Obejrzane</label>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="cancel-btn">Anuluj</button>
                                <button type="submit" class="save-btn">Zapisz</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            const container = document.getElementById('detailsModalContainer');
            container.innerHTML = modalHTML;
            const modal = container.querySelector('.modal-overlay');
            const form = container.querySelector('#custom-add-form');
            const closeModal = () => container.innerHTML = '';

            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
            form.querySelector('.cancel-btn').addEventListener('click', closeModal);
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const title = document.getElementById('custom-title').value.trim();
                if (!title) {
                    showCustomAlert('Błąd', 'Tytuł jest wymagany.', 'error');
                    return;
                }

                const type = document.querySelector('input[name="custom-type"]:checked').value;
                const list = document.querySelector('input[name="custom-list"]:checked').value;
                const targetListName = (type === 'movie' ? 'movies' : 'series') + list;

                const newItem = {
                    id: `custom_${Date.now()}`,
                    title: title,
                    year: document.getElementById('custom-year').value || '',
                    poster: document.getElementById('custom-poster').value.trim() || null,
                    type: type,
                    overview: 'Dodano ręcznie.',
                    genres: [],
                    isFavorite: false,
                    dateAdded: Date.now(),
                };

                if (list === 'Watched') {
                    newItem.rating = null;
                    newItem.review = "";
                }

                data[targetListName].unshift(newItem);
                await saveData();
                renderList(data[targetListName], targetListName);
                closeModal();
                showCustomAlert('Sukces!', 'Dodano nowy wpis.', 'success');
            });
        }

        async function getActorDetails(actorId) {
            try {
                const plDetailsRes = await fetch(`${API_BASE_URL}/person/${actorId}?api_key=${API_KEY}&language=pl-PL`);
                if (!plDetailsRes.ok) throw new Error('Błąd odpowiedzi sieciowej dla danych PL.');
                let details = await plDetailsRes.json();

                if (!details.biography) {
                    const enDetailsRes = await fetch(`${API_BASE_URL}/person/${actorId}?api_key=${API_KEY}&language=en-US`);
                    if (enDetailsRes.ok) {
                        const enDetails = await enDetailsRes.json();
                        details.biography = enDetails.biography;
                    }
                }

                const creditsRes = await fetch(`${API_BASE_URL}/person/${actorId}/combined_credits?api_key=${API_KEY}&language=pl-PL`);
                if (!creditsRes.ok) throw new Error('Błąd odpowiedzi sieciowej dla filmografii.');
                const credits = await creditsRes.json();

                const uniqueCast = credits.cast.filter((item, index, self) => index === self.findIndex(t => t.id === item.id));

                const knownFor = [...uniqueCast].filter(item => item.poster_path).sort((a, b) => b.vote_count - a.vote_count).slice(0, 10);

                const fullFilmography = [...uniqueCast].filter(item => item.release_date || item.first_air_date).sort((a, b) => {
                    const dateA = a.release_date || a.first_air_date;
                    const dateB = b.release_date || b.first_air_date;
                    return new Date(dateB) - new Date(dateA);
                });

                return { name: details.name, biography: details.biography, profile_path: details.profile_path, known_for: knownFor, full_filmography: fullFilmography };
            } catch (error) {
                console.error("Błąd pobierania danych o aktorze:", error);
                return null;
            }
        }

        async function openActorDetailsModal(actorId) {
            const actorModalContainer = document.getElementById('actorModalContainer');
            actorModalContainer.innerHTML = `<div class="modal-overlay actor-modal-overlay"><div class="actor-modal-content" style="text-align:center; color: var(--text-secondary);">Ładowanie...</div></div>`;

            const actorData = await getActorDetails(actorId);

            if (!actorData) {
                actorModalContainer.innerHTML = `<div class="modal-overlay actor-modal-overlay"><div class="actor-modal-content" style="text-align:center; color: var(--primary-color);">Nie udało się załadować danych aktora.</div></div>`;
                setTimeout(() => actorModalContainer.innerHTML = '', 2000);
                return;
            }

            const knownForHTML = actorData.known_for.map(item => {
                const posterSrc = item.poster_path ? IMAGE_BASE_URL.replace('w500', 'w200') + item.poster_path : POSTER_PLACEHOLDER;
                return `<div class="known-for-item"><img src="${posterSrc}" alt="${item.title || item.name}" loading="lazy" onerror="this.onerror=null; this.src='${POSTER_PLACEHOLDER}';"><strong>${item.title || item.name}</strong></div>`;
            }).join('');


            const modalHTML = `
                <div class="modal-overlay actor-modal-overlay">
                    <div class="modal-content actor-modal-content">
                        <button class="icon-button modal-top-close-btn" title="Zamknij"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
                        <div class="actor-header">
                            ${actorData.profile_path ? `<img src="${IMAGE_BASE_URL}${actorData.profile_path}" alt="${actorData.name}">` : ICONS.person.replace('class="placeholder-svg"', 'class="placeholder-svg" style="width:150px; height:150px; border-radius:50%;"')}
                            <h2>${actorData.name}</h2>
                        </div>
                        <div class="actor-bio">${actorData.biography || 'Brak dostępnej biografii.'}</div>
                        ${knownForHTML ? `<div class="known-for-section"><h3>Znany/a z</h3><div class="known-for-scroller">${knownForHTML}</div></div>` : ''}
                        ${actorData.full_filmography && actorData.full_filmography.length > 0 ? `<div class="filmography-controls"><button id="toggle-filmography-btn" class="filmography-button">Pokaż pełną filmografię</button></div><div id="full-filmography-container" style="display: none;"></div>` : ''}
                    </div>
                </div>`;
            actorModalContainer.innerHTML = modalHTML;

            const filmographyBtn = document.getElementById('toggle-filmography-btn');
            if (filmographyBtn) {
                filmographyBtn.addEventListener('click', () => {
                    const container = document.getElementById('full-filmography-container');
                    if (container.style.display === 'block') {
                        container.style.display = 'none';
                        filmographyBtn.textContent = 'Pokaż pełną filmografię';
                    } else {
                        if (container.innerHTML === '') {
                             const filmographyHTML = actorData.full_filmography.map(item => {
                                const year = (item.release_date || item.first_air_date || '----').substring(0, 4);
                                const poster = item.poster_path ? IMAGE_BASE_URL.replace('w500', 'w92') + item.poster_path : POSTER_PLACEHOLDER;
                                const isAlreadyAdded = Object.values(data).flat().some(i => String(i.id) === String(item.id));
                                const actionHTML = isAlreadyAdded
                                    ? `<span class="already-added-info"><svg viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" /></svg> Już na liście</span>`
                                    : `<button class="add-filmography-item-btn" data-id="${item.id}" data-type="${item.media_type}">Dodaj do obejrzenia</button>`;

                                return `
                                <div class="filmography-item">
                                    <div class="filmography-item-header">
                                        <img src="${poster}" alt="" loading="lazy" onerror="this.onerror=null; this.src='${POSTER_PLACEHOLDER}';">
                                        <div class="filmography-item-info">
                                            <strong>${item.title || item.name}</strong>
                                            <span>${year}</span>
                                            <span class="character">jako: ${item.character || 'Brak informacji'}</span>
                                        </div>
                                    </div>
                                    <div class="filmography-item-details">
                                        <p class="filmography-overview">${item.overview || 'Brak opisu.'}</p>
                                        <div class="filmography-actions">${actionHTML}</div>
                                    </div>
                                </div>`;
                             }).join('');
                             container.innerHTML = filmographyHTML;
                        }
                        container.style.display = 'block';
                        filmographyBtn.textContent = 'Ukryj filmografię';
                    }
                });
            }

            const modal = actorModalContainer.querySelector('.modal-overlay');
            const closeModal = () => actorModalContainer.innerHTML = '';
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal();

                const header = e.target.closest('.filmography-item-header');
                if(header) {
                    const details = header.nextElementSibling;
                    if(details && details.classList.contains('filmography-item-details')) {
                        details.style.display = details.style.display === 'block' ? 'none' : 'block';
                    }
                }

                const addButton = e.target.closest('.add-filmography-item-btn');
                if(addButton) {
                    addItemFromFilmography(addButton);
                }
            });
            modal.querySelector('.modal-top-close-btn').addEventListener('click', closeModal);
        }

        async function addItemFromFilmography(button) {
            button.disabled = true;
            button.textContent = 'Dodawanie...';
            const { id, type } = button.dataset;

            const itemDetails = await getItemDetails(id, type);
            if (!itemDetails) {
                button.textContent = 'Błąd!';
                setTimeout(() => { button.textContent = 'Dodaj do obejrzenia'; button.disabled = false; }, 2000);
                return;
            }

            itemDetails.dateAdded = Date.now();
            const targetListName = (type === 'movie' ? 'movies' : 'series') + 'ToWatch';
            data[targetListName].unshift(itemDetails);
            await saveData();

            const actionContainer = button.parentElement;
            actionContainer.innerHTML = `<span class="already-added-info"><svg viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" /></svg> Dodano!</span>`;
        }

        function setupInteractiveStars(item) { const container = document.querySelector('.star-rating-interactive'); if(!container) return; const ratingDisplay = document.getElementById('rating-display'); const decBtn = document.getElementById('rating-decrement'); const incBtn = document.getElementById('rating-increment'); let currentRating = item.rating || 0; const starPath = "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"; for(let i=1; i<=5; i++){ const star = document.createElement('div'); star.className = 'star'; star.innerHTML = `<svg class="star-background" viewBox="0 0 24 24"><path d="${starPath}"/></svg><svg class="star-foreground" viewBox="0 0 24 24"><path d="${starPath}"/></svg>`; container.appendChild(star); } const updateRatingUI = (rating) => { currentRating = rating; container.dataset.rating = currentRating; container.querySelectorAll('.star-foreground').forEach((star, index) => { const score = currentRating - index; if (score >= 1) { star.style.clipPath = 'inset(0 0 0 0)'; } else if (score > 0) { star.style.clipPath = `inset(0 ${100 - score * 100}% 0 0)`; } else { star.style.clipPath = 'inset(0 100% 0 0)'; } }); ratingDisplay.textContent = `Twoja ocena: ${currentRating.toFixed(1)} / 5.0`; decBtn.disabled = currentRating <= 0; incBtn.disabled = currentRating >= 5; }; const calculateRatingFromEvent = (e) => { const rect = container.getBoundingClientRect(); const mouseX = e.clientX - rect.left; const rawRating = (mouseX / rect.width) * 5; return Math.max(0, Math.min(5, Math.round(rawRating * 2) / 2)); }; container.addEventListener('mousemove', e => updateRatingUI(calculateRatingFromEvent(e))); container.addEventListener('mouseleave', () => updateRatingUI(parseFloat(container.dataset.rating))); container.addEventListener('click', e => { const newRating = calculateRatingFromEvent(e); updateRatingUI(newRating); }); decBtn.addEventListener('click', () => { let rating = parseFloat(container.dataset.rating); if (rating > 0) { updateRatingUI(rating - 0.5); } }); incBtn.addEventListener('click', () => { let rating = parseFloat(container.dataset.rating); if (rating < 5) { updateRatingUI(rating + 0.5); } }); updateRatingUI(currentRating); }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker zarejestrowany: ', registration);
                }).catch(registrationError => {
                    console.log('Rejestracja ServiceWorker nie powiodła się: ', registrationError);
                });
            });
        }
    </script>
</body>
</html>
